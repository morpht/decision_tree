class DecisionTree{"use strict";constructor(id){this._validation(id);const steps=this._loadSteps(id);if(Array.isArray(steps)){this.config={id:id,first_step:steps[0],steps:steps};this.storage=this._loadStorage(id);this.activate();document.querySelectorAll("#"+id+" .step .step__answer").forEach(function(answer){if(answer.hasAttribute("href")){answer.addEventListener("click",()=>{this.trackAnswer(answer.attributes.href.value.replace("#",""),answer.hasAttribute("data-answer-path")?answer.attributes["data-answer-path"].value:false)})}},this)}else{throw new Error("Please follow proper HTML structure.")}}_loadSteps(id){const steps=[];document.querySelector("#"+id).querySelectorAll(".step").forEach(function(el,index){steps.push(el.id)});if(steps.length<1){console.warn("Decision tree should have at least one step.")}return steps}_validateHistory(storage){const history=storage[this.config.id].history??"";const steps=this.config.steps?this.config.steps:this._loadSteps(this.config.id);if(history.length>0&&steps.length>0){const valid=history.every(function(val){return steps.indexOf(val)!==-1});if(valid===false){storage[this.config.id].history=[this.config.first_step];storage[this.config.id].active=this.config.first_step;this.storage=storage;this._saveStorage()}}return storage}_loadStorage(id){let storage=JSON.parse(localStorage.getItem(id))||{};if(storage[this.config.id]!==undefined){storage=this._validateHistory(storage);return storage[this.config.id]}return{first_step:this.config.first_step,active:this.config.first_step,history:[this.config.first_step]}}_saveStorage(){let storage=JSON.parse(localStorage.getItem(this.config.id))||{};storage[this.config.id]=this.storage;if(!this.storage.active||!this.storage.history){storage={}}localStorage.setItem(this.config.id,JSON.stringify(storage))}_validation(id){const steps=document.querySelector("#"+id).querySelectorAll(".step");steps.forEach(function(el,index){if(!el.hasAttribute("id")){console.warn("One of your steps in decision tree with ID "+id+" does not have ID element filled.")}});document.querySelector("#"+id).querySelectorAll(".step__answer").forEach(function(el,index){if(!el.hasAttribute("href")){console.warn("One of your answers in decision tree id "+id+" does not have href filled.")}if(!el.hasAttribute("data-answer-path")){console.warn("One of your answers in decision tree id "+id+" does not have data-answer-path filled.")}})}_showSummary(){this._cleanHTML();const display_summary_in_step=document.querySelector("#"+this.config.id+" #"+this.storage.active).hasAttribute("data-show-summary");if(this.storage.active){var furtherQuestions=document.querySelector("#"+this.config.id+" #"+this.storage.active+" .step__answer");if(furtherQuestions!=null){furtherQuestions=furtherQuestions.innerHTML.replace(/<\!--.*?-->/g,"").trim().length}}if(furtherQuestions===0||furtherQuestions==null||display_summary_in_step){this.show("#"+this.config.id+" .decision-tree__summary");let infoHTML="";if(this.storage.history){const history=this.storage.history.slice();history.forEach(el=>{if(document.querySelector("#"+this.config.id+" #"+el+" .step__info")){infoHTML+=document.querySelector("#"+this.config.id+" #"+el+" .step__info").innerHTML}});const summary_element=document.querySelector("#"+this.config.id+" .decision-tree__summary");if(summary_element&&summary_element.nodeType){if(summary_element.querySelector(".decision-tree__summary_infos")!==null){summary_element.querySelector(".decision-tree__summary_infos").innerHTML=infoHTML}else{const divElement=document.createElement("div");divElement.classList.add("decision-tree__summary_infos");divElement.innerHTML=infoHTML;summary_element.appendChild(divElement);this.filter()}}else{console.warn("Your decision tree with ID "+this.config.id+" does not have element with class decision-tree__summary.")}}else{this.hide("#"+this.config.id+" .decision-tree__summary")}}}_cleanHTML(){document.querySelectorAll("#"+this.config.id+" .decision-tree__summary_infos *").forEach(function(element){element.remove()});document.querySelectorAll("#"+this.config.id+" .decision-tree__summary").forEach(element=>{element.removeAttribute("style")})}activate(){try{this.trackGA(this.storage.active+"/");document.querySelectorAll("#"+this.config.id+".step").forEach(step=>{this.hide(step)});this.toggleFooter();if(!document.querySelector("#"+this.config.id+" .decision-tree__summary")){const divElement=document.createElement("div");divElement.classList.add("decision-tree__summary");document.querySelector("#"+this.config.id+" .decision-tree__footer").prepend(divElement)}this.show("#"+this.config.id+" #"+this.storage.active);this._showSummary();this.filter();document.querySelector("#"+this.config.id+" .decision-tree__footer .step__button--back").onclick=()=>{this.trackBackButton()};document.querySelector("#"+this.config.id+" .decision-tree__footer .step__button--restart").onclick=()=>{this.trackRestartButton()};document.querySelector("#"+this.config.id).classList.add("dt-initialized");this._saveStorage()}catch(e){this.hide("#"+this.config.id);console.warn("Cannot activate decision tree with ID "+this.config.id+". Incorrect HTML structure.")}}hide(elem){try{if(typeof elem==="string"){elem=document.querySelector(elem)}if(elem&&elem.nodeType){elem.style.display="none";return true}}catch(e){console.warn("Please check decision tree with ID "+this.config.id+". Incorrect HTML structure.")}return false}show(elem){try{if(typeof elem==="string"){elem=document.querySelector(elem)}if(elem&&elem.nodeType){elem.style.display="block";return true}}catch(e){console.warn("Please check decision tree "+this.config.id+". Incorrect HTML structure.")}return false}filter(){document.querySelectorAll("#"+this.config.id+" .decision-tree__summary li").forEach(info=>{let show_step=true;if(info.hasAttribute("data-pass-filter")){const pass=info.attributes["data-pass-filter"].value.split(",");show_step=pass.every(and=>{return this.is_in_history(and.trim())})}if(info.hasAttribute("data-stop-filter")){const stop=info.attributes["data-stop-filter"].value.split(",");stop.forEach(and=>{const result=this.is_in_history(and.trim());if(show_step===true&&result===true){show_step=false}})}if(show_step===false){this.hide(info)}else{this.show(info)}})}is_in_history(filter_array){return filter_array.split(" ").every(object=>{return this.storage.history.includes(object)})}toggleFooter(){if(!document.querySelector("#"+this.config.id+" .decision-tree__footer")){const divElement=document.createElement("div");divElement.classList.add("decision-tree__footer");divElement.innerHTML="<button class='step__button step__button--back'>Back</button>\n<button class='step__button step__button--restart'>Restart</button>";document.querySelector("#"+this.config.id).appendChild(divElement)}if(this.storage.history&&this.storage.history.length>1){this.show("#"+this.config.id+" .decision-tree__footer")}else{this.hide("#"+this.config.id+" .decision-tree__footer")}}trackAnswer(nextStep,datakey){if(datakey){this.trackGA(this.storage.active+"/"+datakey)}this.hide("#"+this.config.id+" #"+this.storage.active);this.show("#"+this.config.id+" #"+nextStep);this.trackGA(nextStep+"/");this.storage.active=nextStep;this.storage.history.push(this.storage.active);this._saveStorage(this.config.id);this.trackAttribute(nextStep);this._showSummary();this.toggleFooter()}trackBackButton(){if(this.storage.history.length<=1){return}this.hide("#"+this.config.id+" #"+this.storage.active);const previousStep=this.storage.history[this.storage.history.length-2];this.show("#"+this.config.id+" #"+previousStep);this.trackGA(previousStep+"/back");this.hide("#"+this.config.id+" #"+this.storage.active+" .step__info");this._cleanHTML();this.storage.active=previousStep;this.storage.history.pop();this._saveStorage();this.trackAttribute(this.storage.active);this.toggleFooter()}trackRestartButton(){this.hide("#"+this.config.id+" #"+this.storage.active);this.trackGA(this.storage.active+"/restart");this.storage.active=this.config.first_step;this.show("#"+this.config.id+" #"+this.storage.active);this.trackGA(this.storage.active);this.storage.history=[this.config.first_step];this._saveStorage();this.trackAttribute(this.storage.active);this.toggleFooter();this._cleanHTML()}trackAttribute(id){let step=document.querySelector("#"+this.config.id+" #"+id);if(step!=null){let stepOutcome=step.getAttribute("data-cookie");if(stepOutcome!==null){this.cookie(stepOutcome.split("=")[0],stepOutcome.split("=")[1])}}}trackGA(path){if(typeof gtag==="function"&&drupalSettings.google_analytics!==undefined){gtag("config",drupalSettings.google_analytics.account,{page_path:window.location.href+this.config.id+"/"+path})}else if(typeof ga==="function"&&ga.getAll()[0].get("clientId")!==null&&ga.getAll()[0].get("trackingId")!==null){ga("create",ga.getAll()[0].get("trackingId"),{clientId:ga.getAll()[0].get("clientId")});ga("send","pageview",window.location.href+this.config.id+"/"+path)}}cookie(name,value,days){let expires;if(days){const date=new Date;date.setTime(date.getTime()+days*24*60*60*1e3);expires=" expires="+date.toGMTString()}else{expires=""}document.cookie=encodeURIComponent(name)+"="+encodeURIComponent(value)+";"+expires+";"+" path=/; SameSite=None; Secure"}}document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll(".decision-tree").forEach(function(el){if(el.hasAttribute("id")){new DecisionTree(el.id)}else{console.warn("Decision tree does not have ID.")}})},false);